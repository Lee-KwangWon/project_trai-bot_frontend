# 🔐 AI 기반 무역 규제 레이더 플랫폼 - 선택적 인증 시스템 구현 가이드 v2.2

## 📋 개요

본 문서는 **Public API 우선 설계**와 **선택적 개인화**를 지원하는 **선택적 인증 시스템(Optional Authentication System)**의 구현 가이드입니다. 무역 정보 조회는 로그인 없이 사용 가능하며, 사용자가 원할 때 로그인하여 개인화 기능을 추가로 활용할 수 있는 현업 표준 아키텍처를 제시합니다.

### 🆕 v2.2 주요 변경사항
- **보안 강화**: 사용자 정보에서 불필요한 필드 완전 제거 (`id`, `roles`, `registrationType`)
- **OAuth 프로필 이미지**: Google, Naver, Kakao 프로필 이미지 완벽 지원
- **에러 메시지 보안화**: 내부 시스템 정보 노출 방지를 위한 일반적 메시지 적용
- **북마크 ID 문자열화**: 예측 불가능한 문자열 ID로 보안 강화

### 🎯 핵심 설계 철학
- ✅ **Public First**: 핵심 기능은 로그인 없이 즉시 사용 가능
- ✅ **Progressive Enhancement**: 로그인 시 점진적 기능 향상
- ✅ **Optional Authentication**: 인증이 필수가 아닌 선택사항
- ✅ **보안 우선**: HttpOnly 쿠키로 XSS/CSRF 완전 차단
- ✅ **사용자 선택권**: 익명 사용 vs 개인화 서비스 자유 선택

### 🏗️ 기술 아키텍처
- **상태 관리**: 사용자 정보만 클라이언트에서 관리
- **인증 토큰**: HttpOnly 쿠키에서 서버가 자동 관리
- **API 통신**: Public/Private API 구분된 요청 처리
- **선택적 인증**: 로그인 없이 기본 기능, 로그인 시 개인화 기능 추가
- **보안**: CSRF 방지 + XSS 완전 차단

### 🔄 선택적 인증 플로우
```
사용자 상태              API 레벨                서버 처리
┌─────────────────┐     ┌──────────────────┐     ┌──────────────────┐
│   익명 사용자     │────►│   Public API     │────►│ 기본 무역정보 제공 │
│ (Cookie 없음)    │     │ (로그인 불필요)    │     │                  │
└─────────────────┘     └──────────────────┘     └──────────────────┘
          │                        
          ▼ 로그인 선택              
┌─────────────────┐     ┌──────────────────┐     ┌──────────────────┐
│  로그인 사용자    │────►│ Public API +     │────►│ 기본정보 +        │
│ (HttpOnly Cookie)│     │ 개인화 기능       │     │ 개인화 데이터     │
│                 │────►│ Private API      │────►│ 북마크/대시보드   │
└─────────────────┘     └──────────────────┘     └──────────────────┘
```

---

## 🏛️ 핵심 아키텍처

### 인증 상태 관리 원칙
1. **JWT 토큰**: HttpOnly 쿠키에서만 저장 (JavaScript 접근 불가)
2. **사용자 정보**: 서버 API 호출로 가져와서 클라이언트 상태에 저장
3. **API 구분**: Public API (인증 선택) + Private API (인증 필수)
4. **점진적 향상**: 로그인 없이 시작 → 필요시 로그인 → 개인화 기능 활용

### API 접근 패턴
- **Public API**: 모든 검색/분석 기능 - 로그인 없이 전체 이용 가능
- **Private API**: 북마크/대시보드 - 로그인 필수
- **선택적 개인화**: Public API도 로그인 시 추가 데이터 제공

---

## 📊 시스템 구성 요소

### 1. 상태 관리 계층

#### 인증 상태 스토어
```typescript
// v2.2 User 타입 정의 (보안 강화)
type User = {
  email: string;                 // 사용자 이메일 주소
  name: string;                  // 사용자 표시명
  profileImage?: string;         // OAuth 프로필 이미지 URL (선택적)
}

// 인증 상태 관리
type AuthState = {
  user: User | null;             // 사용자 정보 (로그인 시에만)
  isAuthenticated: boolean;      // 인증 상태
  isLoading: boolean;           // 초기화 진행 상태
}
```

#### 🔒 v2.2 보안 강화 사항
- ❌ **제거된 필드**: `id` (내부 식별자), `roles` (권한 정보), `registrationType` (등록 방식)
- ✅ **유지된 필드**: `email`, `name` (UI 표시용 필수 정보만)
- 🆕 **추가된 필드**: `profileImage` (OAuth 소셜 로그인 프로필 이미지)

#### 핵심 설계 원칙
- **최소 상태**: 토큰 관리 완전 제거, 사용자 정보만 관리
- **서버 우선**: 인증 검증은 모두 서버에서 처리
- **자동 동기화**: HttpOnly 쿠키로 탭 간 자동 동기화

### 2. API 통신 계층

#### 선택적 인증 요청 처리
```
API Request Flow:
1. Public API 요청 → withCredentials 설정으로 쿠키 선택적 전송
2. 서버에서 쿠키 존재 여부 확인
3. 익명: 기본 데이터 반환
4. 인증: 기본 데이터 + 개인화 데이터 반환
```

#### 자동 인증 처리
- **인터셉터**: 401 응답 시 자동 로그아웃 처리
- **쿠키 관리**: 서버에서 자동 설정/삭제
- **오류 복구**: 인증 실패 시 Public 모드로 자동 전환

### 3. 라우팅 및 가드 계층

#### 라우트 접근 정책
- **오픈 라우트**: 메인, 검색, 결과 페이지 (누구나 접근)
- **보호 라우트**: 북마크, 대시보드 (로그인 필수)
- **게스트 라우트**: 로그인, 회원가입 (비로그인만 접근)

#### 점진적 가드 시스템
```
Route Guard Logic:
1. 초기화 완료 대기
2. 라우트별 접근 권한 확인
3. 필요시 리디렉션 또는 로그인 유도
4. 권한 부족 시 적절한 안내 제공
```

---

## 🚀 핵심 기능 흐름

### 1. 앱 초기화 프로세스

#### 시작 시퀀스
```
App Start → 인증 상태 확인 → UI 렌더링
1. 쿠키 존재 확인 (브라우저 자동)
2. 서버 인증 검증 (/auth/verify)
3. 성공: 사용자 정보 저장 + 인증 상태 설정
4. 실패: 익명 상태로 초기화
5. 로딩 완료 → 메인 UI 표시
```

#### 안전한 초기화
- **Race Condition 방지**: 단일 초기화 보장
- **Error Boundary**: 인증 실패가 앱 크래시로 이어지지 않음
- **Graceful Fallback**: 네트워크 오류 시 익명 모드로 동작

### 2. 로그인 프로세스

#### 일반 로그인 흐름
```
폼 입력 → 서버 인증 → 쿠키 설정 → 상태 업데이트 → 리디렉션
1. 이메일/비밀번호 + Remember Me 설정
2. /auth/login API 호출
3. 서버: JWT 생성 + HttpOnly 쿠키 설정
4. 클라이언트: 사용자 정보만 상태에 저장
5. 이전 페이지 또는 홈으로 리디렉션
```

#### OAuth 로그인 흐름
```
OAuth 버튼 → 외부 인증 → 콜백 처리 → 상태 동기화 → 프로필 이미지 처리
1. OAuth URL로 리디렉션 (`/api/oauth2/authorization/{provider}`)
2. 외부 제공업체에서 인증 (Google, Naver, Kakao)
3. 서버 콜백: 사용자 정보 + 프로필 이미지 획득 → JWT 쿠키 설정
4. 프론트엔드 콜백: 사용자 정보 조회 (email, name, profileImage 포함)
5. 인증 상태 업데이트 + 프로필 이미지 UI 반영 완료
```

#### 🖼️ OAuth 프로필 이미지 지원 상세
- **Google**: `picture` 필드에서 프로필 이미지 URL 자동 획득
- **Naver**: `profile_image` 필드에서 프로필 이미지 URL 자동 획득  
- **Kakao**: `thumbnail_image` 필드에서 프로필 이미지 URL 자동 획득
- **UI 처리**: 프로필 이미지가 있으면 아바타 표시, 없으면 기본 아이콘 표시

### 3. API 요청 처리

#### Public API 사용 패턴
```
검색 요청 → 자동 쿠키 전송 → 개인화 여부 판단 → 적절한 응답
1. 모든 사용자가 동일한 API 엔드포인트 호출
2. withCredentials로 쿠키 자동 전송
3. 서버에서 인증 상태에 따라 응답 레벨 조정
4. 익명: 기본 정보만
5. 인증: 기본 정보 + 개인화 추천/히스토리
```

#### Private API 보호 메커니즘
```
Private 요청 → 인증 검증 → 권한 확인 → 보호된 데이터 제공
1. 북마크/대시보드 API 호출 시
2. 쿠키 존재 및 유효성 검증
3. 사용자별 데이터 접근 권한 확인
4. 인증 실패 시 401 반환 → 자동 로그아웃
```

### 4. 로그아웃 및 세션 관리

#### 명시적 로그아웃
```
로그아웃 버튼 → 서버 세션 정리 → 쿠키 삭제 → 상태 초기화
1. /auth/logout API 호출
2. 서버: 쿠키 만료 설정 (Max-Age=0)
3. 클라이언트: 사용자 상태 클리어
4. 로그인 페이지 또는 홈으로 리디렉션
```

#### 자동 세션 만료 처리
```
API 요청 → 401 응답 → 자동 로그아웃 → 익명 모드 전환
1. 모든 API 요청에서 401 모니터링
2. 토큰 만료 감지 시 즉시 상태 클리어
3. 사용자에게 세션 만료 알림
4. 현재 페이지가 Public이면 그대로 유지
5. Private 페이지면 로그인 페이지로 유도
```

---

## 🛡️ 보안 설계

### 1. 다층 보안 체계

#### 클라이언트 사이드 보안 (v2.2 강화)
- **XSS 완전 차단**: JWT를 JavaScript로 접근 불가
- **상태 격리**: 민감한 토큰 정보 클라이언트에서 완전 배제
- **자동 정리**: 컴포넌트 언마운트 시 민감 데이터 자동 클리어
- **🆕 최소 정보 원칙**: 사용자 정보에서 `id`, `roles`, `registrationType` 완전 제거
- **🆕 에러 메시지 일반화**: 내부 시스템 정보 노출 방지 ("이메일/비밀번호 불일치" → "인증 실패")

#### 서버 사이드 보안 (v2.2 강화)
- **HttpOnly 쿠키**: 브라우저에서만 자동 전송
- **CSRF 방지**: SameSite=Strict 설정
- **토큰 검증**: 모든 요청에서 JWT 서명 및 만료 확인
- **🆕 리소스 ID 보안**: 북마크 ID를 `number` → `string`으로 변경하여 예측 불가능하게 처리
- **🆕 OAuth 프로필 보안**: 외부 OAuth에서 가져온 프로필 이미지 URL 검증 및 안전한 저장

### 2. 권한 기반 접근 제어

#### 계층적 권한 시스템
```
권한 레벨:
- Anonymous: Public API 접근
- Authenticated: Public API + Private API 기본 접근
- Role-based: 특정 역할 기반 고급 기능 접근
```

#### 동적 권한 검증
- **실시간 검증**: 매 요청마다 서버에서 권한 재확인
- **역할 기반 필터링**: 사용자 역할에 따른 데이터 필터링
- **권한 위임**: 관리자 권한으로 사용자 대신 작업 수행

---

## ⚡ 성능 최적화

### 1. 상태 관리 최적화

#### 선택적 리렌더링
- **세분화된 선택자**: 필요한 상태만 구독하여 불필요한 리렌더링 방지
- **메모이제이션**: 복잡한 권한 계산 결과 캐싱
- **배치 업데이트**: 여러 상태 변경을 하나로 묶어서 처리

#### 메모리 관리
- **자동 정리**: 컴포넌트 언마운트 시 이벤트 리스너 제거
- **약한 참조**: 메모리 누수 방지를 위한 WeakMap/WeakSet 활용
- **점진적 로딩**: 필요한 시점에만 무거운 데이터 로드

### 2. 네트워크 최적화

#### 요청 최적화
- **요청 중복 제거**: 동일한 API 동시 호출 방지
- **캐싱 전략**: 사용자 정보는 메모리 캐시, 검색 결과는 조건부 캐시
- **배경 새로고침**: 사용자 상호작용 중단 없이 데이터 업데이트

#### 오프라인 지원
- **서비스 워커**: 기본 페이지 캐싱으로 오프라인 접근 지원
- **상태 동기화**: 온라인 복구 시 서버와 클라이언트 상태 동기화
- **에러 복구**: 네트워크 오류 시 자동 재시도 메커니즘

---

## 🎯 사용자 경험 설계

### 1. 점진적 향상 전략

#### 익명 사용자 여정
```
검색 사용 → 결과 확인 → 추가 기능 발견 → 로그인 유도 → 개인화 혜택
1. 즉시 검색 가능 (마찰 없는 진입)
2. 결과에서 개인화 기능 미리보기
3. "로그인 시 더 많은 기능" 자연스러운 안내
4. 북마크/알림 등 가치 제안 명확히 전달
```

#### 로그인 사용자 혜택 (v2.2 업데이트)
- **개인화 추천**: 이전 검색 기반 맞춤 정보 제공
- **히스토리 관리**: 검색 기록 자동 저장 및 재검색 지원
- **북마크 시스템**: 관심 품목 저장 및 변동 알림 (보안 강화된 문자열 ID 사용)
- **대시보드**: 개인화된 무역 정보 요약 제공
- **🆕 프로필 개인화**: OAuth 소셜 로그인 시 프로필 이미지 자동 연동 및 아바타 표시

### 2. 매끄러운 전환 경험

#### 인증 상태 전환
- **상태 유지**: 검색 중이던 내용 로그인 후에도 그대로 유지
- **컨텍스트 보존**: 현재 페이지에서 로그인 후 동일 위치로 복귀
- **점진적 노출**: 로그인 후 새로운 기능들을 단계적으로 소개

#### 오류 상황 처리
- **우아한 저하**: 인증 오류 시 Public 기능으로 자동 전환
- **명확한 안내**: 권한 부족 시 필요한 액션 명확히 안내
- **빠른 복구**: 오류 해결을 위한 간단한 경로 제공

---

## 🔧 구현 고려사항

### 1. 개발 환경 설정

#### 환경 변수 관리
```
환경별 설정:
- 개발: HTTP 허용, 관대한 CORS 정책
- 스테이징: HTTPS 강제, 제한적 CORS
- 운영: 모든 보안 정책 활성화
```

#### 개발 도구 지원
- **Hot Reload**: 인증 상태 유지하면서 개발 서버 재시작
- **디버깅 도구**: 인증 플로우 시각화 및 디버깅 지원
- **테스트 계정**: 다양한 권한 레벨 테스트 계정 제공

### 2. 배포 및 운영

#### 모니터링 포인트
- **인증 성공률**: 로그인 시도 대비 성공률 추적
- **API 응답 시간**: Public/Private API 성능 모니터링
- **보안 이벤트**: 비정상적인 인증 시도 감지 및 알림

#### 확장성 고려
- **세션 스토리지**: Redis 등 외부 세션 스토어 지원
- **로드 밸런싱**: 여러 서버 간 세션 공유 메커니즘
- **마이크로서비스**: 인증 서비스 분리 및 독립 배포 지원

---

## ✅ 핵심 장점

### 🚀 사용자 경험
- **즉시 사용 가능**: 회원가입 없이 핵심 기능 바로 이용
- **자연스러운 업그레이드**: 필요시에만 로그인으로 기능 확장
- **끊김 없는 전환**: 인증 상태 변경 시에도 사용 맥락 유지

### 🛡️ 보안성
- **현업 최고 수준**: 대기업 표준 보안 정책 적용
- **다층 방어**: XSS, CSRF, 토큰 탈취 등 다양한 공격 벡터 차단
- **최소 권한 원칙**: 필요한 권한만 최소한으로 부여

### ⚡ 개발 효율성
- **단순한 구조**: 복잡한 토큰 관리 로직 완전 제거
- **타입 안전성**: TypeScript로 모든 인증 관련 타입 보장
- **테스트 용이성**: 명확한 책임 분리로 단위 테스트 작성 용이

### 🔧 유지보수성
- **명확한 책임 분리**: 클라이언트는 UI 상태만, 서버는 보안 관리
- **확장 가능**: OAuth, 다중 인증 등 추가 기능 쉽게 확장
- **모니터링 친화적**: 각 계층별 명확한 메트릭 수집 포인트

---

**🎉 Public API 우선 설계와 선택적 인증을 완벽 지원하는 현업 표준 구현 가이드 v2.2 완성!**

**✨ 핵심 혁신:**
- 🔓 로그인 없이 즉시 사용 가능한 핵심 기능
- 🎯 사용자 선택에 따른 점진적 기능 향상
- 🛡️ 최고 수준의 보안성과 단순성 동시 달성
- 🚀 현업에서 검증된 엔터프라이즈 아키텍처

**🆕 v2.2 추가 혁신:**
- 🔐 **보안 대폭 강화**: 클라이언트 불필요 정보 완전 제거로 공격 표면 최소화
- 📱 **OAuth 프로필 완벽 지원**: Google, Naver, Kakao 프로필 이미지 seamless 연동
- 🛡️ **에러 메시지 보안화**: 내부 시스템 정보 노출 방지로 보안 위험 차단
- 🔒 **예측 불가능한 ID**: 북마크 등 리소스 ID 문자열화로 brute-force 공격 방지

---

## 🔄 v2.1 → v2.2 마이그레이션 체크리스트

### 프론트엔드 변경사항
- [ ] **User 타입 업데이트**: `id`, `roles`, `registrationType` 필드 제거
- [ ] **OAuth 프로필 이미지**: `profileImage` 필드 추가 및 UI 처리 로직 구현
- [ ] **북마크 ID 타입**: `number` → `string` 타입 변경
- [ ] **에러 메시지 처리**: 구체적 에러 메시지 → 일반화된 메시지 대응

### 백엔드 연동 확인사항  
- [ ] **API 응답 구조**: 사용자 정보 응답에서 불필요 필드 제거 확인
- [ ] **OAuth 콜백**: 프로필 이미지 URL 처리 로직 확인
- [ ] **에러 응답**: 보안화된 에러 메시지 반환 확인
- [ ] **리소스 ID**: 문자열 기반 ID 처리 로직 확인